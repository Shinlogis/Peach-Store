<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 제품 하위 카테고리 매퍼 -->
<mapper namespace="peachstore.repository.ProductSubcategoryDAO">

	<resultMap id="ProductSubcategoryResultMap" type="peachstore.domain.ProductSubcategory">
		<result column="product_subcategory_id" property="productSubcategoryId"/>
		<result column="product_subcategory_name" property="productSubcategoryName"/>
		<result column="is_active" property="isActive"/>
		
		<!-- 하나의 등급을 가짐 -->
		<association column="product_topcategory_id" property="productTopcategory"
			javaType="peachstore.domain.ProductTopcategory" select="peachstore.repository.ProductTopcategoryDAO.findById" />
	</resultMap>
	
	<!-- 상위카테고리와 조인해둔 resultMap -->
	<resultMap id="SubcategoryWithTopcategoryMap" type="peachstore.domain.ProductSubcategory" >
		<id property="productSubcategoryId" column="product_subcategory_id"/>
		<result property="productSubcategoryName" column="product_subcategory_name"/>
		<result property="isActive" column="is_active"/>
		
		<association property="productTopcategory" javaType="peachstore.domain.ProductTopcategory">
			<id property="productTopcategoryId" column="pt_id"/>
			<result property="productTopcategoryName" column="pt_name"/>
			<result property="isActive" column="pt_active"/>
		</association>
	</resultMap>
    
    <!-- 상위 카테고리와 조인한 서브 카테고리 전체 조회 (검색 포함) -->
    <select id="selectAllWithTopcategory" resultMap="SubcategoryWithTopcategoryMap" parameterType="map">
    	select 
    		ps.product_subcategory_id,
	        ps.product_subcategory_name,
	        ps.product_topcategory_id,
	        ps.is_active,
	        
	        pt.product_topcategory_id AS pt_id,
	        pt.product_topcategory_name AS pt_name,
	        pt.is_active AS pt_active
	   
    	from product_subcategory ps
    	join product_topcategory pt
    		on ps.product_topcategory_id = pt.product_topcategory_id
    	where ps.is_active = true 
    		and pt.is_active = true
    		<if test="searchKey != null and searchKey != ''">
	        and pt.product_topcategory_name like concat('%', #{searchKey}, '%')
	   		</if>
    </select>
    
    <!-- 등록 -->
    <insert id="insert" parameterType="peachstore.domain.ProductSubcategory">
    	insert into product_subcategory(product_subcategory_name, product_topcategory_id)
    	values(#{productSubcategoryName}, #{productTopcategory.productTopcategoryId})
    </insert>
    
    <!-- 수정 -->
	<update id="update" parameterType="peachstore.domain.ProductSubcategory">
		update product_subcategory
		set product_subcategory_name = #{productSubcategoryName}
			, is_active = #{isActive}
		where product_subcategory_id = #{productSubcategoryId}
	</update>

	<!-- id로 서브카테고리 조회 -->
	<select id="selectById" resultMap="SubcategoryWithTopcategoryMap" parameterType="int">
		select 
    		ps.product_subcategory_id,
	        ps.product_subcategory_name,
	        ps.product_topcategory_id,
	        ps.is_active,
	        
	        pt.product_topcategory_id AS pt_id,
	        pt.product_topcategory_name AS pt_name,
	        pt.is_active AS pt_active
	   
    	from product_subcategory ps
    	join product_topcategory pt
    		on ps.product_topcategory_id = pt.product_topcategory_id
    	where ps.product_subcategory_id = #{productSubCategory}
    		and ps.is_active = true 
    		and pt.is_active = true
	</select>
	
	<!-- TopcategoryId 상위 카테고리의 모든 하위 카테고리 -->
	<select id="selectAllSubcategoryByTopcategoryId" resultMap="SubcategoryWithTopcategoryMap" parameterType="int">
		select 
			ps.product_subcategory_id,
	        ps.product_subcategory_name,
	        ps.product_topcategory_id,
	        ps.is_active,
	        
	        pt.product_topcategory_id AS pt_id,
	        pt.product_topcategory_name AS pt_name,
	        pt.is_active AS pt_active
	    from product_subcategory ps
    	join product_topcategory pt
    		on ps.product_topcategory_id = pt.product_topcategory_id
    	where
    		ps.is_active = true 
    		and pt.is_active = true
    		and pt.product_topcategory_id = #{value}
	</select>
</mapper>
