<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 제품 상위 카테고리 매퍼 -->
<mapper namespace="peachstore.repository.topcategory.ProductTopcategoryDAO">

	<resultMap id="ProductTopcategoryResultMap" type="peachstore.domain.ProductTopcategory">
		<result column="product_topcategory_id" property="productTopcategoryId"/>
		<result column="product_topcategory_name" property="productTopcategoryName"/>
		<result column="is_active" property="isActive"/>
	</resultMap>
	
	<!-- 하위 카테고리와 조인해둔 resultMap -->
	<resultMap id="ProductTopcategoryWithSubcategoryMap" type="peachstore.domain.ProductTopcategory">
	    <id property="productTopcategoryId" column="product_topcategory_id"/>
	    <result property="productTopcategoryName" column="product_topcategory_name"/>
	    <result property="isActive" column="is_active"/>
	
	    <collection property="productSubcategory" ofType="peachstore.domain.ProductSubcategory">
	        <id property="productSubcategoryId" column="product_subcategory_id"/>
	        <result property="productSubcategoryName" column="product_subcategory_name"/>
	        <result property="isActive" column="sub_is_active"/>
	    </collection>
	</resultMap>
	
	<!-- 전체 조회 (검색 포함) -->
	<select id="selectAll" resultMap="ProductTopcategoryResultMap" parameterType="map">
	    select product_topcategory_id, product_topcategory_name, is_active
	    from product_topcategory
	    where is_active = true
	    <if test="searchKey != null and searchKey != ''">
	        and product_topcategory_name like concat('%', #{searchKey}, '%')
	    </if>
	    order by product_topcategory_id asc
	</select>
	
	<!-- 전체조회개선예정 -->
	<select id="selectAllWithSubcategories" resultMap="ProductTopcategoryWithSubcategoryMap">
	    SELECT
	        pt.product_topcategory_id,
	        pt.product_topcategory_name,
	        pt.is_active,
	        ps.product_subcategory_id,
	        ps.product_subcategory_name,
	        ps.is_active AS sub_is_active
	    FROM product_topcategory pt
	    LEFT JOIN product_subcategory ps
	        ON pt.product_topcategory_id = ps.product_topcategory_id
	        AND ps.is_active = true
	    WHERE pt.is_active = true
	    ORDER BY pt.product_topcategory_id, ps.product_subcategory_id
	</select>

	<!-- 등록 -->
	<insert id="insert" parameterType="peachstore.domain.ProductTopcategory">
		insert into product_topcategory(product_topcategory_name) 
		values(#{productTopcategoryName})
	</insert>

	<!-- 수정 -->
	<update id="update" parameterType="peachstore.domain.ProductTopcategory">
	    update product_topcategory
	    set 
	    	product_topcategory_name = #{productTopcategoryName}
	        , is_active = #{isActive}
	    where product_topcategory_id = #{productTopcategoryId}
	</update>

	<!-- pk를 통한 조회 -->
	<select id="findById" resultMap="ProductTopcategoryWithSubcategoryMap"  parameterType="int">
	    select * 
	    from product_topcategory 
	    where product_topcategory_id = #{productTopcategoryId}
	</select>
	
</mapper>
